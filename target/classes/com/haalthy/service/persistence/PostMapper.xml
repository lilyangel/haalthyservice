<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.haalthy.service.persistence.PostMapper">
  <cache />
  	  <select id="getPostById" parameterType="int" resultType="Post">
	    SELECT
			PostID,
			Type,
			InsertUserName,
			body,
			Tags,
			CountComments,
			CountBookmarks,
			CountViews,
			Closed,
			IsBroadcast,
			DateInserted,
			DateUpdated,
			isActive
	    FROM POST
	    WHERE POSTID = #{PostID}
	  </select>
	  
	<insert id="addPost" useGeneratedKeys="true"
    	keyProperty="postID" keyColumn = "PostID">
  		INSERT into Post (InsertUserName, body, Tags, CountComments, CountBookmarks, CountViews, Closed, IsBroadcast, DateInserted,DateUpdated, isActive)
 			 VALUES (#{insertUserName},#{body},#{tags}, #{countComments}, #{countBookmarks}, #{countViews}, #{closed},#{isBroadcast}, #{dateInserted}, #{dateUpdated}, #{isActive})
	</insert>
	
	<insert id="addPostTag" parameterType="java.util.List">
		INSERT 
		into PostTag(PostID, TagID, CreateTime)
			VALUES
			<foreach collection="list" item="PostTag" index="index" separator=",">
       			(#{PostTag.postID}, #{PostTag.tagId}, #{PostTag.createTime})
       		</foreach>
	</insert>
	
	<update id = "inactivePost" parameterType = "Post">
		UPDATE Post SET
			isActive = "0"
		WHERE POSTID = #{postID} AND InsertUserName = #{insertUserName}
	</update>
	
	<select id = "getPostsByTagnames" parameterType="java.util.List" resultType = "Post">
		SELECT
			PostID,
			Type,
			InsertUserName,
			body,
			Tags,
			CountComments,
			CountBookmarks,
			CountViews,
			Closed,
			IsBroadcast,
			DateInserted,
			DateUpdated,
			isActive,
			image
	    FROM Post, User
	    WHERE PostID IN(
	    	SELECT PostID 
	    	FROM PostTag
	    	WHERE 
	    		PostTag.TagID IN
	      			<foreach item="tag" index="index" collection="list" open="(" separator="," close=")">
        				#{tag.tagId}
  					</foreach>
	    		
	    	)AND (Post.InsertUserName = User.Username)
	</select>
</mapper>